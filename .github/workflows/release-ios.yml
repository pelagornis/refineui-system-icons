name: Release iOS Platform

on:
  push:
    tags:
      - "*"

jobs:
  release-ios:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Get version
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Update iOS versions
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"

          # Update root package.json
          sed -i '' "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" package.json

          # Update iOS Package.swift version
          sed -i '' "s/version:.*/version: \"$VERSION\"/" Package.swift

          echo "Updated iOS versions to $VERSION"

      - name: Build iOS platform
        run: |
          python3 scripts/generate_ios_swift.py

      - name: Validate iOS package
        run: |
          ulimit -n 65536
          echo "File descriptor limit increased to $(ulimit -n)"

          cd ios/RefineIcons

          swift package resolve
          swift build

      - name: Create iOS Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_version.outputs.version }}
          files: |
            ios/RefineIcons/Sources/RefineIcons.swift
            ios/RefineIcons/Sources/RefineIcons+Extensions.swift
            ios/RefineIcons/Package.swift
            ios/RefineIcons/README.md
            Package.swift
          body: |
            ## üéâ iOS Platform Release ${{ steps.get_version.outputs.version }}

            ### üì¶ Installation

            #### Swift Package Manager
            ```swift
            // Package.swift
            .package(url: "https://github.com/pelagornis/refineui-system-icons.git", from: "${{ steps.get_version.outputs.version }}")
            ```

            ### üçé Features
            - Native iOS integration
            - SF Symbols compatible
            - SwiftUI and UIKit support
            - 434+ icons with multiple sizes and styles
            - Optimized for iOS performance

            ### üìÅ Files
            iOS source code and Package.swift files are attached below.

            ### üöÄ Publishing Status
            - ‚úÖ Swift Package Manager: Available
            - ‚úÖ GitHub Release: Created
        env:
          GITHUB_TOKEN: ${{ secrets.PELAGORNIS }}
