name: Release iOS Platform

on:
  push:
    tags:
      - "*"

jobs:
  release-ios:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PELAGORNIS }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Get version
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Update iOS versions
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"

          # iOS doesn't need specific version files, just build
          echo "âœ… iOS version $VERSION ready for build"

      - name: Build iOS platform
        run: |
          python3 scripts/generate_ios_swift.py

      - name: Validate iOS package
        run: |
          ulimit -n 65536
          echo "File descriptor limit increased to $(ulimit -n)"

          cd ios/RefineIcons

          swift package resolve
          swift build

      - name: Create iOS Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_version.outputs.version }}
          body: |
            ## ğŸ‰ iOS Platform Release ${{ steps.get_version.outputs.version }}

            ### ğŸ“¦ Installation

            #### Swift Package Manager
            ```swift
            // Package.swift
            .package(url: "https://github.com/pelagornis/refineui-system-icons.git", from: "${{ steps.get_version.outputs.version }}")
            ```

            ### ğŸ Features
            - Native iOS integration
            - SF Symbols compatible
            - SwiftUI and UIKit support
            - 434+ icons with multiple sizes and styles
            - Optimized for iOS performance

            ### ğŸ“ Files
            iOS source code and Package.swift files are attached below.

            ### ğŸš€ Publishing Status
            - âœ… Swift Package Manager: Available
            - âœ… GitHub Release: Created
        env:
          GITHUB_TOKEN: ${{ secrets.PELAGORNIS }}
