name: Release iOS Platform

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Release version"
        required: true
        default: "1.0.0"

jobs:
  release-ios:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Get version
        id: get_version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION=${{ github.event.inputs.version }}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Update iOS versions
        run: |
          # Update root package.json
          npm version ${{ steps.get_version.outputs.version }} --no-git-tag-version

          # Update iOS Podspec version
          sed -i '' "s/s\.version.*=.*'.*'/s.version = '${{ steps.get_version.outputs.version }}'/" RefineIcons.podspec

          # Update iOS Package.swift version
          sed -i '' "s/version:.*/version: \"${{ steps.get_version.outputs.version }}\"/" Package.swift

          echo "Updated iOS versions to ${{ steps.get_version.outputs.version }}"

      - name: Build iOS platform
        run: |
          python3 scripts/generate_ios_swift.py

      - name: Validate iOS package
        run: |
          cd ios/RefineIcons
          xcodebuild -scheme RefineIcons -destination 'platform=iOS Simulator,name=iPhone 14' build

      - name: Create iOS Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ios/RefineIcons/**
            RefineIcons.podspec
            Package.swift
          body: |
            ## üéâ iOS Platform Release ${{ steps.get_version.outputs.version }}

            ### üì¶ Installation
            ```ruby
            # CocoaPods
            pod 'RefineIcons'

            # Swift Package Manager
            .package(url: "https://github.com/refineui/system-icons.git", from: "${{ steps.get_version.outputs.version }}")
            ```

            ### üçé Features
            - Native iOS integration
            - SF Symbols compatible
            - SwiftUI and UIKit support
            - 434+ icons with multiple sizes and styles
            - Optimized for iOS performance

            ### üìÅ Files
            iOS source code, Podspec, and Package.swift files are attached below.
        env:
          GITHUB_TOKEN: ${{ secrets.PELAGORNIS }}
